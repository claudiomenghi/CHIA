<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CHIAReplacementConsole.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CHIAFramework</a> &gt; <a href="index.source.html" class="el_package">it.polimi.console</a> &gt; <span class="el_source">CHIAReplacementConsole.java</span></div><h1>CHIAReplacementConsole.java</h1><pre class="source lang-java linenums">package it.polimi.console;

import it.polimi.action.CHIAException;
import it.polimi.automata.IBA;
import it.polimi.automata.io.out.IBAToElementTrasformer;
import it.polimi.automata.io.out.XMLWriter;
import it.polimi.checker.SatisfactionValue;
import it.polimi.checker.intersection.acceptingpolicies.AcceptingPolicy;
import it.polimi.checker.intersection.acceptingpolicies.AcceptingPolicy.AcceptingType;
import it.polimi.constraints.Constraint;
import it.polimi.constraints.components.RefinementGenerator;
import it.polimi.constraints.components.Replacement;
import it.polimi.constraints.components.SubProperty;
import it.polimi.constraints.io.in.constraint.ConstraintReader;
import it.polimi.constraints.io.in.replacement.ReplacementReader;
import it.polimi.constraints.io.out.constraint.ConstraintToStringTrasformer;
import it.polimi.constraints.io.out.replacement.ReplacementToStringTransformer;
import it.polimi.replacementchecker.ReplacementChecker;
import it.polimi.statemachine.states.CHIAReplacementState;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.PrintStream;
import java.lang.management.ManagementFactory;
import java.lang.management.ThreadMXBean;
import java.util.concurrent.TimeUnit;

import javax.xml.parsers.ParserConfigurationException;

import org.apache.log4j.Logger;
import org.xml.sax.SAXException;

/**
 * contains the console which is used for the replacement checking
 * 
 * @author Claudio Menghi
 *
 */
public class CHIAReplacementConsole {

<span class="fc" id="L42">	private static final Logger LOGGER = Logger</span>
<span class="fc" id="L43">			.getLogger(CHIAReplacementConsole.class);</span>

<span class="fc" id="L45">	private CHIAReplacementState chiaState = CHIAReplacementState.INIT;</span>
	/**
	 * contains the constraint to be considered
	 */
	protected Constraint constraint;
	/**
	 * contains the replacement to be considered
	 */
	protected Replacement replacement;

	/**
	 * contains the new constraint computed
	 */
	protected Constraint newConstraint;
	/**
	 * is the checker used in the replacement checking activity
	 */
	protected ReplacementChecker replacementChecker;

	/**
	 * is the model from which the replacement is obtained
	 */
	protected IBA model;

	/**
	 * contains the refinement obtained by the current model and the replacement
	 */
	protected IBA refinement;

	protected AcceptingType policy;

	/**
	 * creates a new replacement console
	 */
<span class="fc" id="L79">	public CHIAReplacementConsole() {</span>
<span class="fc" id="L80">		this.policy = AcceptingType.BA;</span>
<span class="fc" id="L81">	}</span>

	public void loadConstraint(String constraintFilePath)
			throws FileNotFoundException, ParserConfigurationException,
			SAXException, IOException {

<span class="pc bpc" id="L87" title="1 of 2 branches missed.">		if (this.chiaState.isPerformable(ConstraintReader.class)) {</span>
			try {
<span class="fc" id="L89">				this.constraint = new ConstraintReader(new File(</span>
<span class="fc" id="L90">						constraintFilePath)).perform();</span>
<span class="fc" id="L91">				this.chiaState = chiaState.perform(ConstraintReader.class);</span>

<span class="fc" id="L93">				LOGGER.info(&quot;Constraint Loaded&quot;);</span>
<span class="nc" id="L94">			} catch (CHIAException e) {</span>
<span class="nc" id="L95">				LOGGER.info(e.toString());</span>
<span class="pc" id="L96">			}</span>
		} else {
<span class="nc" id="L98">			LOGGER.info(&quot;The constraint reading action cannot be performed into the state &quot;</span>
<span class="nc" id="L99">					+ this.chiaState.name());</span>
		}
<span class="fc" id="L101">	}</span>

	public void dispConstraint() throws Exception {

<span class="pc bpc" id="L105" title="1 of 2 branches missed.">		if (this.chiaState.isPerformable(ConstraintToStringTrasformer.class)) {</span>
			try {
<span class="fc" id="L107">				ConstraintToStringTrasformer action = new ConstraintToStringTrasformer(</span>
						this.constraint);
<span class="fc" id="L109">				this.chiaState = chiaState</span>
<span class="fc" id="L110">						.perform(ConstraintToStringTrasformer.class);</span>
<span class="fc" id="L111">				LOGGER.info(action.perform());</span>
<span class="nc" id="L112">			} catch (CHIAException e) {</span>
<span class="nc" id="L113">				LOGGER.info(e.toString());</span>
<span class="pc" id="L114">			}</span>
		} else {
<span class="nc" id="L116">			this.printNotExecutableMessage(ConstraintToStringTrasformer.class);</span>
		}
<span class="fc" id="L118">	}</span>

	public void loadReplacement(String replacementFilePath)
			throws FileNotFoundException, ParserConfigurationException,
			SAXException, IOException {

<span class="pc bpc" id="L124" title="1 of 2 branches missed.">		if (this.chiaState.isPerformable(ReplacementReader.class)) {</span>
			try {
<span class="fc" id="L126">				ReplacementReader rr=new ReplacementReader(new File(</span>
						replacementFilePath));
<span class="fc" id="L128">				this.replacement = rr.perform();</span>
<span class="fc" id="L129">				this.model=rr.getModel();</span>
<span class="fc" id="L130">				this.chiaState = chiaState.perform(ReplacementReader.class);</span>
<span class="fc" id="L131">				LOGGER.info(&quot;Replacement Loaded&quot;);</span>

<span class="nc" id="L133">			} catch (Exception e) {</span>
<span class="nc" id="L134">				LOGGER.info(e.toString());</span>
<span class="pc" id="L135">			}</span>
		} else {
<span class="nc" id="L137">			PrintStream out = System.out;</span>
<span class="nc" id="L138">			out.println(&quot;The replacement reading action cannot be performed into the state &quot;</span>
<span class="nc" id="L139">					+ this.chiaState.name());</span>
		}
<span class="fc" id="L141">	}</span>

	public void dispReplacement() throws Exception {

<span class="pc bpc" id="L145" title="1 of 2 branches missed.">		if (this.chiaState.isPerformable(ReplacementToStringTransformer.class)) {</span>
			try {
<span class="fc" id="L147">				ReplacementToStringTransformer action = new ReplacementToStringTransformer(</span>
						this.replacement);
<span class="fc" id="L149">				this.chiaState = chiaState</span>
<span class="fc" id="L150">						.perform(ReplacementToStringTransformer.class);</span>
<span class="fc" id="L151">				LOGGER.info(action.perform());</span>
<span class="nc" id="L152">			} catch (CHIAException e) {</span>
<span class="nc" id="L153">				LOGGER.info(e.toString());</span>
<span class="pc" id="L154">			}</span>
		} else {
<span class="nc" id="L156">			this.printNotExecutableMessage(ReplacementToStringTransformer.class);</span>
		}
<span class="fc" id="L158">	}</span>

	public void saveRefinement(String filePath) {
<span class="nc bnc" id="L161" title="All 2 branches missed.">		if (this.chiaState.isPerformable(RefinementGenerator.class)) {</span>
			try {
<span class="nc" id="L163">				RefinementGenerator action = new RefinementGenerator(</span>
						this.model, this.replacement);
<span class="nc" id="L165">				this.refinement = action.perform();</span>

<span class="nc" id="L167">				new XMLWriter(new File(filePath),</span>
<span class="nc" id="L168">						new IBAToElementTrasformer().transform(this.refinement)).perform();</span>
<span class="nc" id="L169">				this.chiaState = chiaState.perform(RefinementGenerator.class);</span>

<span class="nc" id="L171">			} catch (Exception e) {</span>
<span class="nc" id="L172">				LOGGER.info(e.toString());</span>
<span class="nc" id="L173">			}</span>
		} else {
<span class="nc" id="L175">			this.printNotExecutableMessage(ReplacementToStringTransformer.class);</span>
		}
<span class="nc" id="L177">	}</span>

	public void replacementChecking() {
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">		if (this.chiaState.isPerformable(ReplacementChecker.class)) {</span>
			try {

<span class="nc" id="L183">				SubProperty subProperty = this.constraint</span>
<span class="nc" id="L184">						.getSubProperty(this.replacement.getModelState());</span>
<span class="nc" id="L185">				this.replacementChecker = new ReplacementChecker(</span>
<span class="nc" id="L186">						this.replacement, subProperty, AcceptingPolicy.getAcceptingPolicy(</span>
<span class="nc" id="L187">								this.policy, this.replacement.getAutomaton(),</span>
<span class="nc" id="L188">								subProperty.getAutomaton()));</span>

<span class="nc" id="L190">				ThreadMXBean thradBean = ManagementFactory.getThreadMXBean();</span>
<span class="nc" id="L191">				long startTime = thradBean.getCurrentThreadCpuTime();</span>
<span class="nc" id="L192">				SatisfactionValue result = this.replacementChecker.perform();</span>
<span class="nc" id="L193">				long endTime = thradBean.getCurrentThreadCpuTime();</span>
<span class="nc" id="L194">				LOGGER.info(&quot;Verification result: &quot; + result.toString());</span>
<span class="nc" id="L195">				LOGGER.info(&quot;Verification time: &quot;</span>
<span class="nc" id="L196">						+ Long.toString(TimeUnit.MILLISECONDS.convert(</span>
								(endTime - startTime), TimeUnit.NANOSECONDS))
						+ &quot; ms&quot;);
<span class="nc bnc" id="L199" title="All 2 branches missed.">				if (result.equals(SatisfactionValue.NOTSATISFIED)) {</span>
<span class="nc" id="L200">					LOGGER.info(&quot;COUNTEREXAMPLE: &quot;</span>
<span class="nc" id="L201">							+ this.replacementChecker.getCouterexample());</span>

				}
<span class="nc bnc" id="L204" title="All 2 branches missed.">				if (!result.equals(SatisfactionValue.NOTSATISFIED)) {</span>
<span class="nc" id="L205">					LOGGER.info(&quot;Dimension of the intersection automaton (states+transitions): &quot;</span>
<span class="nc" id="L206">							+ (this.replacementChecker.getUpperIntersectionBA()</span>
<span class="nc" id="L207">									.size() + this.replacementChecker</span>
<span class="nc" id="L208">									.getLowerIntersectionBA().size()));</span>
				}

<span class="nc" id="L211">				this.chiaState = chiaState.perform(ReplacementChecker.class);</span>

<span class="nc" id="L213">			} catch (CHIAException e) {</span>
<span class="nc" id="L214">				LOGGER.info(e.toString());</span>
<span class="nc" id="L215">			}</span>
		} else {
<span class="fc" id="L217">			this.printNotExecutableMessage(ReplacementChecker.class);</span>
		}
<span class="fc" id="L219">	}</span>


	private void printNotExecutableMessage(Class&lt;?&gt; action) {
<span class="fc" id="L223">		PrintStream out = System.out;</span>
<span class="fc" id="L224">		out.println(&quot;The &quot; + action.getName()</span>
				+ &quot; action cannot be performed into the state &quot;
<span class="fc" id="L226">				+ this.chiaState.name());</span>
<span class="fc" id="L227">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>