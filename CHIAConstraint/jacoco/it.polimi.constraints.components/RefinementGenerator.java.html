<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>RefinementGenerator.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CHIAConstraint</a> &gt; <a href="index.source.html" class="el_package">it.polimi.constraints.components</a> &gt; <span class="el_source">RefinementGenerator.java</span></div><h1>RefinementGenerator.java</h1><pre class="source lang-java linenums">package it.polimi.constraints.components;

import it.polimi.action.CHIAAction;
import it.polimi.automata.IBA;
import it.polimi.automata.state.State;
import it.polimi.automata.transition.ModelTransitionFactory;
import it.polimi.automata.transition.Transition;
import it.polimi.constraints.transitions.PluggingTransition;

import com.google.common.base.Preconditions;

/**
 * Checks if the replacement is a valid replacement for a state of the specified
 * model
 * 
 * @author Claudio Menghi
 *
 */
public class RefinementGenerator extends CHIAAction&lt;IBA&gt; {

	/**
	 * the model to be considered
	 */
	private final IBA model;
	/**
	 * the replacement to be analyzed
	 */
	private final Replacement replacement;

	/**
	 * creates a new refinement checker for the specified model and replacement
	 * 
	 * @param model
	 *            the model to be considered
	 * @param replacement
	 *            the replacement to be analyzed
	 * @throws NullPointerException
	 *             if one of the parameters is null
	 */
	public RefinementGenerator(IBA model, Replacement replacement) {
<span class="nc" id="L41">		super(&quot;Refinement Generator&quot;);</span>
<span class="nc" id="L42">		Preconditions.checkNotNull(model,</span>
				&quot;the model to be considered cannot be null&quot;);
<span class="nc" id="L44">		Preconditions.checkNotNull(replacement,</span>
				&quot;The replacement to be considered cannot be null&quot;);
<span class="nc" id="L46">		this.model = model;</span>
<span class="nc" id="L47">		this.replacement = replacement;</span>

<span class="nc" id="L49">	}</span>

	/**
	 * checks is the replacement is a valid replacement for one of the black box
	 * states of the model
	 * 
	 * @throws IllegalArgumentException
	 *             if the replacement is not a valid replacement for the model
	 */
	public void checkValidReplacement() {
<span class="nc bnc" id="L59" title="All 2 branches missed.">		if (!model.getBlackBoxStates().contains(replacement.getModelState())) {</span>
<span class="nc" id="L60">			throw new IllegalArgumentException(</span>
					&quot;The state of the replacement must be a black box state of the original model&quot;);
		}
<span class="nc bnc" id="L63" title="All 2 branches missed.">		if (!model.getAcceptStates().contains(replacement.getModelState())</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">				&amp;&amp; !replacement.getAutomaton().getAcceptStates().isEmpty()) {</span>
<span class="nc" id="L65">			throw new IllegalArgumentException(</span>
					&quot;The automaton that refines a black box state wich is not accepting cannot contain accepting states&quot;);
		}
<span class="nc bnc" id="L68" title="All 2 branches missed.">		if (!model.getInitialStates().contains(replacement.getModelState())</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">				&amp;&amp; !replacement.getAutomaton().getInitialStates().isEmpty()) {</span>
<span class="nc" id="L70">			throw new IllegalArgumentException(</span>
					&quot;The automaton that refines a black box state wich is not accepting cannot contain initial states&quot;);
		}
<span class="nc" id="L73">		this.checkInTransitions();</span>
<span class="nc" id="L74">		this.checkOutTransitions();</span>

<span class="nc" id="L76">	}</span>

	/**
	 * 
	 * @return the refined automaton
	 * @throws IllegalArgumentException
	 *             if the replacement is not a valid replacement
	 */
	public IBA perform() {
<span class="nc" id="L85">		this.checkValidReplacement();</span>
<span class="nc" id="L86">		IBA refinement = model.clone();</span>

<span class="nc" id="L88">		refinement</span>
<span class="nc" id="L89">				.addPropositions(replacement.getAutomaton().getPropositions());</span>

<span class="nc" id="L91">		refinement.removeState(replacement.getModelState());</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">		for (State replacementState : replacement.getAutomaton().getStates()) {</span>
<span class="nc" id="L93">			refinement.addState(replacementState);</span>
<span class="nc" id="L94">			if (replacement.getAutomaton().getAcceptStates()</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">					.contains(replacementState)) {</span>
<span class="nc" id="L96">				refinement.addAcceptState(replacementState);</span>
			}
<span class="nc" id="L98">			if (replacement.getAutomaton().getInitialStates()</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">					.contains(replacementState)) {</span>
<span class="nc" id="L100">				refinement.addInitialState(replacementState);</span>
			}
<span class="nc" id="L102">			if (replacement.getAutomaton().getBlackBoxStates()</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">					.contains(replacementState)) {</span>
<span class="nc" id="L104">				refinement.addBlackBoxState(replacementState);</span>
			}
<span class="nc" id="L106">		}</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">		for (Transition transition : replacement.getAutomaton()</span>
<span class="nc" id="L108">				.getTransitions()) {</span>

<span class="nc" id="L110">			Transition transitionClone = new ModelTransitionFactory().create(</span>
<span class="nc" id="L111">					transition.getId(), transition.getPropositions());</span>
<span class="nc" id="L112">			refinement.addTransition(replacement.getAutomaton()</span>
<span class="nc" id="L113">					.getTransitionSource(transition), replacement</span>
<span class="nc" id="L114">					.getAutomaton().getTransitionDestination(transition),</span>
					transitionClone);
<span class="nc" id="L116">		}</span>

<span class="nc bnc" id="L118" title="All 2 branches missed.">		for (PluggingTransition inTransition : replacement</span>
<span class="nc" id="L119">				.getIncomingTransitions()) {</span>
<span class="nc" id="L120">			Transition transitionClone = new ModelTransitionFactory().create(</span>
<span class="nc" id="L121">					inTransition.getId(), inTransition.getTransition()</span>
<span class="nc" id="L122">							.getPropositions());</span>

<span class="nc" id="L124">			refinement.addTransition(inTransition.getSource(),</span>
<span class="nc" id="L125">					inTransition.getDestination(), transitionClone);</span>
<span class="nc" id="L126">		}</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">		for (PluggingTransition outTransition : replacement</span>
<span class="nc" id="L128">				.getOutgoingTransitions()) {</span>
<span class="nc" id="L129">			Transition transitionClone = new ModelTransitionFactory().create(</span>
<span class="nc" id="L130">					outTransition.getId(), outTransition.getTransition()</span>
<span class="nc" id="L131">							.getPropositions());</span>

<span class="nc" id="L133">			refinement.addTransition(outTransition.getSource(),</span>
<span class="nc" id="L134">					outTransition.getDestination(), transitionClone);</span>
<span class="nc" id="L135">		}</span>

<span class="nc" id="L137">		return refinement;</span>
	}

	/**
	 * checks the correctness of the incoming transitions
	 * 
	 * @throws Exception
	 */
	private void checkInTransitions() {
<span class="nc bnc" id="L146" title="All 2 branches missed.">		for (Transition incomingTransition : model.getInTransitions(replacement</span>
<span class="nc" id="L147">				.getModelState())) {</span>
<span class="nc" id="L148">			boolean founded = false;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">			for (PluggingTransition inTransition : replacement</span>
<span class="nc" id="L150">					.getIncomingTransitions()) {</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">				if (inTransition.getTransition().equals(incomingTransition)</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">						&amp;&amp; inTransition.getSource().equals(</span>
<span class="nc" id="L153">								model.getTransitionSource(incomingTransition))) {</span>
<span class="nc" id="L154">					founded = true;</span>
				}
<span class="nc" id="L156">			}</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">			if (!founded) {</span>
<span class="nc" id="L158">				throw new IllegalArgumentException(</span>
						&quot;The incoming transition &lt;&quot;
								+ incomingTransition
								+ &quot;&gt; of the model is not associated with an incoming transition of the replacement&quot;);
			}
<span class="nc" id="L163">		}</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">		for (PluggingTransition inTransition : replacement</span>
<span class="nc" id="L165">				.getIncomingTransitions()) {</span>
<span class="nc" id="L166">			boolean founded = false;</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">			for (Transition incomingTransition : model</span>
<span class="nc" id="L168">					.getInTransitions(replacement.getModelState())) {</span>

<span class="nc bnc" id="L170" title="All 2 branches missed.">				if (inTransition.getTransition().equals(incomingTransition)</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">						&amp;&amp; inTransition.getSource().equals(</span>
<span class="nc" id="L172">								model.getTransitionSource(incomingTransition))) {</span>
<span class="nc" id="L173">					founded = true;</span>
				}
<span class="nc" id="L175">			}</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">			if (!founded) {</span>
<span class="nc" id="L177">				throw new IllegalArgumentException(</span>
						&quot;The incoming transition &lt;&quot;
								+ inTransition
								+ &quot;&gt; of the replacement is not associated with an incoming transition of the model&quot;);
			}
<span class="nc" id="L182">		}</span>
<span class="nc" id="L183">	}</span>

	/**
	 * checks the correctness of the incoming transitions
	 * 
	 * @throws Exception
	 */
	private void checkOutTransitions() {
<span class="nc bnc" id="L191" title="All 2 branches missed.">		for (Transition outgoingTransition : model</span>
<span class="nc" id="L192">				.getOutTransitions(replacement.getModelState())) {</span>
<span class="nc" id="L193">			boolean founded = false;</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">			for (PluggingTransition outTransition : replacement</span>
<span class="nc" id="L195">					.getOutgoingTransitions()) {</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">				if (outTransition.getTransition().equals(outgoingTransition)</span>
						&amp;&amp; outTransition
<span class="nc" id="L198">								.getDestination()</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">								.equals(model</span>
<span class="nc" id="L200">										.getTransitionDestination(outgoingTransition))) {</span>
<span class="nc" id="L201">					founded = true;</span>
				}
<span class="nc" id="L203">			}</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">			if (!founded) {</span>
<span class="nc" id="L205">				throw new IllegalArgumentException(</span>
						&quot;The outgoing transition &lt;&quot;
								+ outgoingTransition
								+ &quot;&gt; of the black box state &lt;&quot;
<span class="nc" id="L209">								+ replacement.getModelState()</span>
								+ &quot;&gt; of the model is not associated with an outgoing transition of the replacement&quot;);
			}
<span class="nc" id="L212">		}</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">		for (PluggingTransition outTransition : replacement</span>
<span class="nc" id="L214">				.getOutgoingTransitions()) {</span>
<span class="nc" id="L215">			boolean founded = false;</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">			for (Transition outgointTransition : model</span>
<span class="nc" id="L217">					.getOutTransitions(replacement.getModelState())) {</span>

<span class="nc bnc" id="L219" title="All 2 branches missed.">				if (outTransition.getTransition().equals(outgointTransition)</span>
						&amp;&amp; outTransition
<span class="nc" id="L221">								.getDestination()</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">								.equals(model</span>
<span class="nc" id="L223">										.getTransitionDestination(outgointTransition))) {</span>
<span class="nc" id="L224">					founded = true;</span>
				}
<span class="nc" id="L226">			}</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">			if (!founded) {</span>
<span class="nc" id="L228">				throw new IllegalArgumentException(</span>
						&quot;The outgoing transition &lt;&quot;
								+ outTransition
								+ &quot;&gt; of the replacement is not associated with an outgoing transition of the model&quot;);
			}
<span class="nc" id="L233">		}</span>
<span class="nc" id="L234">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.2.201409121644</span></div></body></html>